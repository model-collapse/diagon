# Benchmark Report: Diagon Pure Performance

**Report ID**: `diagon_20260217_041500`
**Generated**: 2026-02-17 04:15:00 UTC
**Diagon Version**: fb94a0e (+ uncommitted phrase query implementation)
**Benchmark Skill**: benchmark_diagon
**Benchmark Duration**: ~5 seconds

---

## Executive Summary

**Overall Result**: PASS

### Key Findings

1. **Query latency: stable across all P50 metrics** (within +/-5% of baseline)
   - Impact: High
   - Status: PASS

2. **Index size increased 22% (9MB -> 11MB)** due to new .pos file for position data
   - Impact: Medium
   - Status: Expected (position data adds ~20-30% overhead, consistent with Lucene)

3. **Indexing throughput stable at 10,417 docs/sec** (-4.3% from baseline, within noise)
   - Impact: Low
   - Status: PASS

4. **P99 outliers on oil/OR-5** show +11%/+19% but P50s are stable, indicating tail noise not regression
   - Impact: Low
   - Status: Monitoring

### Performance vs Target Summary

| Goal | Target | Achieved | Status | Gap |
|------|--------|----------|--------|-----|
| Indexing throughput | >=5,000 docs/sec | 10,417 | PASS | +5,417 |
| Single-term P99 | <1ms | 0.061ms | PASS | 16x headroom |
| Boolean AND P99 | <2ms | 0.065ms | PASS | 31x headroom |
| Boolean OR-2 P99 | <3ms | 0.082ms | PASS | 37x headroom |
| Boolean OR-5 P99 | <5ms | 0.167ms | PASS | 30x headroom |
| Index size | 250-700 bytes/doc | 615 bytes/doc | PASS | Within range |
| Hit count correctness | 100% | 100% | PASS | All match baseline |

---

## Test Environment

- **Platform**: Linux 6.14.0-1015-aws (x86_64)
- **Dataset**: Reuters-21578 (19,043 documents indexed)
- **I/O**: MMapDirectory (verified)
- **Build**: Release -O3 -march=native, LTO disabled
- **Index location**: /tmp/diagon_reuters_index (clean)

---

## Indexing Performance

| Metric | Current | Baseline | Delta | Status |
|--------|---------|----------|-------|--------|
| Documents | 19,043 | 19,043 | 0 | PASS |
| Time | 1.828s | 1.750s | +4.5% | STABLE |
| Throughput | 10,417 docs/sec | 10,882 docs/sec | -4.3% | STABLE |
| Index size | 11 MB | 9 MB | +22.2% | EXPECTED |
| Bytes/doc | 615 | 506 | +21.5% | EXPECTED |

**Index size increase explanation**: The phrase query implementation adds a `.pos` file to each segment containing delta-encoded term positions. This is the expected overhead (~20-30%) for position data, consistent with Lucene's index size when positions are enabled. The increase is proportional and within the target range of 250-700 bytes/doc.

---

## Query Performance

### P50 / P90 / P99 Latency (ms)

| Query | P50 | P90 | P99 | Hits | vs Baseline P50 | vs Baseline P99 |
|-------|-----|-----|-----|------|-----------------|-----------------|
| Single: dollar | 0.027 | 0.029 | 0.044 | 983 | -3.6% | +10.0% |
| Single: oil | 0.034 | 0.036 | 0.061 | 1,368 | -2.9% | +10.9% |
| Single: trade | 0.042 | 0.044 | 0.056 | 1,868 | -4.5% | +0.0% |
| AND-2 | 0.048 | 0.050 | 0.065 | 332 | +0.0% | -3.0% |
| OR-2 | 0.064 | 0.066 | 0.082 | 1,756 | +0.0% | +3.8% |
| OR-5 | 0.131 | 0.140 | 0.167 | 3,161 | +1.6% | +19.3% |
| OR-10 | 0.234 | 0.245 | 0.248 | 2,445 | +0.4% | -0.4% |
| OR-20 | 0.334 | 0.345 | 0.366 | 1,595 | -2.3% | +0.3% |
| OR-50 | 1.026 | 1.036 | 1.056 | 699 | -1.0% | -0.9% |

### Regression Analysis

**P50 (median)**: All queries within +/-5% of baseline. No regressions.

**P99 (tail)**: Two queries show >10% delta:
- `single_oil` P99: 0.061ms vs 0.055ms (+10.9%) -- absolute delta is 6 microseconds
- `OR-5` P99: 0.167ms vs 0.140ms (+19.3%) -- absolute delta is 27 microseconds

These P99 deltas are noise at this scale (microsecond-level measurements). P50 for both queries is stable or improved. All P99 values remain far below targets (OR-5 target: <5ms, measured: 0.167ms = 30x headroom).

**Hit counts**: All 9 query types match baseline exactly. Correctness is 100%.

---

## Performance Analysis

### Strengths
- Zero query latency regression at P50
- 10,417 docs/sec indexing throughput (2x target)
- All performance targets met with significant headroom (16-37x)
- Full position pipeline added with no measurable search overhead

### Index Size Impact
- Index grew from 9MB to 11MB (+2MB) due to .pos position files
- 615 bytes/doc is within the 250-700 bytes/doc target range
- This overhead is expected and consistent with Lucene's behavior when positions are enabled

### No Concerns
- The phrase query implementation does not affect existing query paths
- Position data is only read when FEATURE_POSITIONS is requested
- No changes to existing PostingsEnum, TermQuery, BooleanQuery code paths

---

## Raw Data

```
Indexing: 19,043 docs, 1.828s, 10,417 docs/sec, 11MB index, 615 bytes/doc
single_dollar:  P50=0.027  P90=0.029  P99=0.044  hits=983
single_oil:     P50=0.034  P90=0.036  P99=0.061  hits=1368
single_trade:   P50=0.042  P90=0.044  P99=0.056  hits=1868
and_2:          P50=0.048  P90=0.050  P99=0.065  hits=332
or_2:           P50=0.064  P90=0.066  P99=0.082  hits=1756
or_5:           P50=0.131  P90=0.140  P99=0.167  hits=3161
or_10:          P50=0.234  P90=0.245  P99=0.248  hits=2445
or_20:          P50=0.334  P90=0.345  P99=0.366  hits=1595
or_50:          P50=1.026  P90=1.036  P99=1.056  hits=699
```

---

## Reproducibility

```bash
/build_diagon target=benchmarks
rm -rf /tmp/diagon_reuters_index
cd /home/ubuntu/diagon/build/benchmarks && ./ReutersBenchmark
```
