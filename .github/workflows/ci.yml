name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  # ==================== Format Check ====================
  format-check:
    name: Code Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-14

      - name: Check code formatting
        run: |
          find src tests benchmarks -name '*.cpp' -o -name '*.h' | \
            xargs clang-format-14 --dry-run --Werror

  # ==================== Linux Build and Test ====================
  build-linux:
    name: Linux (${{ matrix.compiler }}, ${{ matrix.build_type }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc-13, clang-14]
        build_type: [Release, Debug]
        include:
          - compiler: gcc-13
            cc: gcc-13
            cxx: g++-13
          - compiler: clang-14
            cc: clang-14
            cxx: clang++-14

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          # Add PPA for GCC-13 if needed
          if [[ "${{ matrix.compiler }}" == "gcc-13" ]]; then
            sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
            sudo apt-get update
          fi
          sudo apt-get install -y \
            cmake \
            ninja-build \
            liblz4-dev \
            libzstd-dev \
            zlib1g-dev \
            libgtest-dev \
            libbenchmark-dev \
            ${{ matrix.compiler }}
          # Install g++ variant for gcc
          if [[ "${{ matrix.compiler }}" == "gcc-13" ]]; then
            sudo apt-get install -y g++-13
          fi

      - name: Configure CMake
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DDIAGON_BUILD_TESTS=ON \
            -DDIAGON_BUILD_BENCHMARKS=ON \
            -DDIAGON_ENABLE_SIMD=ON

      - name: Build
        run: cmake --build build --parallel

      - name: Run tests
        working-directory: build
        run: ctest --output-on-failure -j1

      - name: Run benchmarks (Release only)
        if: matrix.build_type == 'Release'
        working-directory: build
        run: |
          ./benchmarks/IndexingBenchmark --benchmark_min_time=0.1
          ./benchmarks/SearchBenchmark --benchmark_min_time=0.1
          ./benchmarks/SIMDBenchmark --benchmark_min_time=0.1

  # ==================== macOS Build and Test ====================
  build-macos:
    name: macOS (${{ matrix.build_type }})
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        build_type: [Release, Debug]

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install \
            cmake \
            ninja \
            lz4 \
            zstd \
            icu4c \
            googletest \
            google-benchmark

      - name: Configure CMake
        run: |
          ICU_PREFIX=$(brew --prefix icu4c)
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DDIAGON_BUILD_TESTS=ON \
            -DDIAGON_BUILD_BENCHMARKS=ON \
            -DDIAGON_ENABLE_SIMD=ON \
            -DCMAKE_PREFIX_PATH="$ICU_PREFIX" \
            -DICU_ROOT="$ICU_PREFIX"

      - name: Build
        run: cmake --build build --parallel

      - name: Run tests
        working-directory: build
        run: ctest --output-on-failure -j1

  # ==================== Sanitizers ====================
  sanitizers:
    name: Sanitizers (AddressSanitizer + UndefinedBehaviorSanitizer)
    runs-on: ubuntu-22.04
    env:
      CC: clang-14
      CXX: clang++-14
      ASAN_OPTIONS: detect_leaks=1:symbolize=1
      UBSAN_OPTIONS: print_stacktrace=1

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            clang-14 \
            liblz4-dev \
            libzstd-dev \
            zlib1g-dev \
            libgtest-dev \
            libbenchmark-dev

      - name: Configure CMake with sanitizers
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DDIAGON_BUILD_TESTS=ON \
            -DDIAGON_BUILD_BENCHMARKS=OFF \
            -DCMAKE_CXX_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer -g"

      - name: Build
        run: cmake --build build --parallel

      - name: Run tests with sanitizers
        working-directory: build
        run: ctest --output-on-failure -j1

  # ==================== Coverage ====================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-22.04
    env:
      CC: gcc-13
      CXX: g++-13

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          # Add PPA for GCC-13
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            gcc-13 \
            g++-13 \
            gcovr \
            liblz4-dev \
            libzstd-dev \
            zlib1g-dev \
            libgtest-dev

      - name: Configure CMake with coverage
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DDIAGON_BUILD_TESTS=ON \
            -DDIAGON_BUILD_BENCHMARKS=OFF \
            -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage"

      - name: Build
        run: cmake --build build --parallel

      - name: Run tests
        working-directory: build
        run: ctest --output-on-failure

      - name: Generate coverage report
        run: |
          gcovr --root . \
            --filter src/ \
            --exclude 'src/.*/test/' \
            --print-summary \
            --xml coverage.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          flags: unittests
          fail_ci_if_error: false
